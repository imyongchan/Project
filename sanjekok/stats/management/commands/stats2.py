import requests
import pandas as pd
from datetime import datetime

from django.core.management.base import BaseCommand
from stats.models import (
    Stats2, Stats3,
    Stats4, Stats5, Stats6,
    Stats7, Stats8, Stats9,
)

# -----------------------------
# 0. 공통 설정
# -----------------------------

API_KEY = 'N2MzYzJlN2ZiNjM1OGRiODJkYmIxYzkxYTY2Zjg1ODI='


def parse_date(value: str):
    """LST_CHN_DE 문자열을 python date로 변환 (Stats1에서만 사용)"""
    s = str(value)
    return datetime.strptime(s, "%Y-%m-%d").date()


def safe_float(x):
    """DT 값이 공백 / '.' 이면 0으로 처리"""
    if x in (None, "", "."):
        return 0.0
    return float(x)




# -----------------------------
# 2. Stats2 ~ Stats9 : 공통 패턴
#    (각각 KOSIS에서 만든 URL만 바꿔주면 됨)
# -----------------------------


def import_stats2():
    """
    Stats2 : 전체 재해 현황 및 분석 - 성별
    KOSIS API에서 C1_OBJ_NM, C2_NM, DT, PRD_DE, C1_NM, ITM_NM, C2_OBJ_NM 컬럼이 온다고 가정.
    """

    # ✅ 여기 URL은 KOSIS에서 '성별' 통계 JSON URL 복사해서 붙여 넣기
    url = f"https://kosis.kr/openapi/Param/statisticsParameterData.do?method=getList&apiKey={API_KEY}&itmId=16118AAD6+&objL1=15118AI7AA+15118AI7AB+15118AI7AC+15118AI7AC00+15118AI7AD+15118AI7AE+15118AI7AJ+&objL2=11101SSB21+11101SSB22+&objL3=&objL4=&objL5=&objL6=&objL7=&objL8=&format=json&jsonVD=Y&prdSe=Y&startPrdDe=2021&endPrdDe=2023&outputFields=OBJ_NM+NM+ITM_NM+PRD_DE+&orgId=118&tblId=DT_11806_N002"  # apiKey까지 포함된 전체 URL이면 그냥 써도 됨

    res = requests.get(url)
    res.raise_for_status()

    data = res.json()
    df = pd.DataFrame(data)

    objs = []
    for row in df.itertuples(index=False):
        obj = Stats2(
            c1_obj_nm=str(row.C1_OBJ_NM),
            c2_nm=str(row.C2_NM),
            dt=safe_float(row.DT),
            prd_de=int(row.PRD_DE),
            c1_nm=str(row.C1_NM),
            itm_nm=str(row.ITM_NM),
            c2_obj_nm=str(row.C2_OBJ_NM),
        )
        objs.append(obj)

    Stats2.objects.all().delete()
    Stats2.objects.bulk_create(objs, batch_size=1000)
    return len(objs)


def import_stats3():


    url = f"https://kosis.kr/openapi/Param/statisticsParameterData.do?method=getList&apiKey={API_KEY}&itmId=16118AAD6+&objL1=15118AI7AA+15118AI7AB+15118AI7AC+15118AI7AC01+15118AI7AD+15118AI7AE+15118AI7AJ+&objL2=11101SSB21+11101SSB22+&objL3=&objL4=&objL5=&objL6=&objL7=&objL8=&format=json&jsonVD=Y&prdSe=Y&startPrdDe=2021&endPrdDe=2023&outputFields=OBJ_NM+NM+ITM_NM+PRD_DE+&orgId=118&tblId=DT_11806_N014"

    res = requests.get(url)
    res.raise_for_status()

    data = res.json()
    df = pd.DataFrame(data)

    objs = []
    for row in df.itertuples(index=False):
        obj = Stats3(
            c1_obj_nm=str(row.C1_OBJ_NM),
            c2_nm=str(row.C2_NM),
            dt=safe_float(row.DT),
            prd_de=int(row.PRD_DE),
            c1_nm=str(row.C1_NM),
            itm_nm=str(row.ITM_NM),
            c2_obj_nm=str(row.C2_OBJ_NM),
        )
        objs.append(obj)

    Stats3.objects.all().delete()
    Stats3.objects.bulk_create(objs, batch_size=1000)
    return len(objs)


def import_stats4():

    url = f"https://kosis.kr/openapi/Param/statisticsParameterData.do?method=getList&apiKey={API_KEY}&itmId=16118AAD6+&objL1=15118AI7AA+15118AI7AAAF+15118AI7AAAG+15118AI7AAAA+15118AI7AAAB+15118AI7AAAC+15118AI7AAAD+15118AI7AAAE+15118AI7AB+15118AI7ABAA+15118AI7ABAn+15118AI7ABAo+15118AI7ABAoo+15118AI7ABAB+15118AI7ABAC+15118AI7AC00+15118AI7AC000+15118AI7ABAp+15118AI7ABAp0+15118AI7ABAD+15118AI7ABAD0+15118AI7ABAE+15118AI7ABAF+15118AI7ABAF0+15118AI7ABAH+15118AI7ABAH0+15118AI7ABAH00+15118AI7ABAJ+15118AI7ABAG+15118AI7ABAq+15118AI7ABAq0+15118AI7ABAK+15118AI7ABAK0+15118AI7ABAM+15118AI7ABAr+15118AI7ABAr0+15118AI7ABAr00+15118AI7ABAr000+15118AI7ABAL+15118AI7ABAN+15118AI7ABAO+15118AI7ABAP+15118AI7ABAQ+15118AI7ABAQ0+15118AI7ABAQ00+15118AI7ABAR+15118AI7ABAS+15118AI7ABAT+15118AI7ABAT0+15118AI7ABAU+15118AI7ABAV+15118AI7ABAV0+15118AI7ABAY+15118AI7ABAZ+15118AI7ABAZ00+15118AI7ABAX+15118AI7ABAs+15118AI7AC+15118AI7ACAA+15118AI7AC01+15118AI7AD+15118AI7ADAB+15118AI7AE+15118AI7AEAA+15118AI7AEAA0+15118AI7AEAA00+15118AI7AEAN+15118AI7AEAN0+15118AI7AEAB+15118AI7AEAC+15118AI7AEAF+15118AI7AEAH+15118AI7AEAI+15118AI7AEAI0+15118AI7AEAJ+15118AI7AEAK+15118AI7AEAM+15118AI7AF+15118AI7AFAA+15118AI7AG+15118AI7AGAC+15118AI7AGAA+15118AI7AGAB+15118AI7AH+15118AI7AHAA+15118AI7AK+15118AI7AKAA+15118AI7AJ+15118AI7AJAA+15118AI7AJAA0+15118AI7AJAA00+15118AI7AJAB+15118AI7AJAC+15118AI7AJAL+15118AI7AJAE+15118AI7AJAE0+15118AI7AJAF+15118AI7AJAG+15118AI7AJAH+15118AI7AJAH0+15118AI7AJAI+15118AI7AC02+15118AI7AC03+15118AI7AC030+15118AI7AJAJ+15118AI7AJAD+&objL2=15118AC1AM+15118AC1AN+15118AC1AO+15118AC1AP+15118AC1AQ+15118AC1AR+15118AC1AT+15118AC1AF+15118AC1AG+15118AC1AH+15118AC1AI+&objL3=&objL4=&objL5=&objL6=&objL7=&objL8=&format=json&jsonVD=Y&prdSe=Y&startPrdDe=2021&endPrdDe=2023&outputFields=OBJ_NM+NM+ITM_NM+PRD_DE+&orgId=118&tblId=DT_11806_N003"

    res = requests.get(url)
    res.raise_for_status()
    data = res.json()
    df = pd.DataFrame(data)

    objs = []
    for row in df.itertuples(index=False):
        obj = Stats4(
            c1_obj_nm=str(row.C1_OBJ_NM),
            c2_nm=str(row.C2_NM),
            dt=safe_float(row.DT),
            prd_de=int(row.PRD_DE),
            c1_nm=str(row.C1_NM),
            itm_nm=str(row.ITM_NM),
            c2_obj_nm=str(row.C2_OBJ_NM),
        )
        objs.append(obj)

    Stats4.objects.all().delete()
    Stats4.objects.bulk_create(objs, batch_size=1000)
    return len(objs)


def import_stats5():


    url = f"https://kosis.kr/openapi/Param/statisticsParameterData.do?method=getList&apiKey={API_KEY}&itmId=16118AAD6+&objL1=15118AI7AA+15118AI7AAAF+15118AI7AAAG+15118AI7AAAA+15118AI7AAAB+15118AI7AAAC+15118AI7AAAD+15118AI7AAAE+15118AI7AB+15118AI7ABAA+15118AI7ABAn+15118AI7ABAo+15118AI7ABAoo+15118AI7ABAB+15118AI7ABAC+15118AI7AC00+15118AI7AC000+15118AI7ABAp+15118AI7ABAp0+15118AI7ABAD+15118AI7ABAD0+15118AI7ABAE+15118AI7ABAF+15118AI7ABAF0+15118AI7ABAH+15118AI7ABAH0+15118AI7ABAH00+15118AI7ABAJ+15118AI7ABAG+15118AI7ABAq+15118AI7ABAq0+15118AI7ABAK+15118AI7ABAK0+15118AI7ABAM+15118AI7ABAr+15118AI7ABAr0+15118AI7ABAr00+15118AI7ABAr000+15118AI7ABAL+15118AI7ABAN+15118AI7ABAO+15118AI7ABAP+15118AI7ABAQ+15118AI7ABAQ0+15118AI7ABAQ00+15118AI7ABAR+15118AI7ABAS+15118AI7ABAT+15118AI7ABAT0+15118AI7ABAU+15118AI7ABAV+15118AI7ABAV0+15118AI7ABAY+15118AI7ABAZ+15118AI7ABAZ00+15118AI7ABAX+15118AI7ABAs+15118AI7AC+15118AI7ACAA+15118AI7AC01+15118AI7AD+15118AI7ADAB+15118AI7AE+15118AI7AEAA+15118AI7AEAA0+15118AI7AEAA00+15118AI7AEAN+15118AI7AEAN0+15118AI7AEAB+15118AI7AEAC+15118AI7AEAF+15118AI7AEAH+15118AI7AEAI+15118AI7AEAI0+15118AI7AEAJ+15118AI7AEAK+15118AI7AEAM+15118AI7AF+15118AI7AFAA+15118AI7AG+15118AI7AGAC+15118AI7AGAA+15118AI7AGAB+15118AI7AH+15118AI7AHAA+15118AI7AK+15118AI7AKAA+15118AI7AJ+15118AI7AJAA+15118AI7AJAA0+15118AI7AJAA00+15118AI7AJAB+15118AI7AJAC+15118AI7AJAL+15118AI7AJAE+15118AI7AJAE0+15118AI7AJAF+15118AI7AJAG+15118AI7AJAH+15118AI7AJAH0+15118AI7AJAI+15118AI7AC02+15118AI7AC03+15118AI7AC030+15118AI7AJAJ+15118AI7AJAD+&objL2=15118AC1AM+15118AC1AN+15118AC1AO+15118AC1AP+15118AC1AQ+15118AC1AR+15118AC1AT+15118AC1AF+15118AC1AG+15118AC1AH+&objL3=&objL4=&objL5=&objL6=&objL7=&objL8=&format=json&jsonVD=Y&prdSe=Y&startPrdDe=2021&endPrdDe=2023&outputFields=OBJ_NM+NM+ITM_NM+PRD_DE+&orgId=118&tblId=DT_11806_N015"

    res = requests.get(url)
    res.raise_for_status()
    data = res.json()
    df = pd.DataFrame(data)

    objs = []
    for row in df.itertuples(index=False):
        obj = Stats5(
            c1_obj_nm=str(row.C1_OBJ_NM),
            c2_nm=str(row.C2_NM),
            dt=safe_float(row.DT),
            prd_de=int(row.PRD_DE),
            c1_nm=str(row.C1_NM),
            itm_nm=str(row.ITM_NM),
            c2_obj_nm=str(row.C2_OBJ_NM),
        )
        objs.append(obj)

    Stats5.objects.all().delete()
    Stats5.objects.bulk_create(objs, batch_size=1000)
    return len(objs)


def import_stats6():


    url = f"https://kosis.kr/openapi/Param/statisticsParameterData.do?method=getList&apiKey={API_KEY}&itmId=16118AAD6+&objL1=15118AI7AA+15118AI7AAAF+15118AI7AAAG+15118AI7AAAA+15118AI7AAAB+15118AI7AAAC+15118AI7AAAD+15118AI7AAAE+15118AI7AB+15118AI7ABAA+15118AI7ABAn+15118AI7ABAo+15118AI7ABAoo+15118AI7ABAB+15118AI7ABAB0+15118AI7ABAp+15118AI7ABAp0+15118AI7ABAD+15118AI7ABAD0+15118AI7ABAF+15118AI7ABAF0+15118AI7ABAH+15118AI7ABAH0+15118AI7ABAH00+15118AI7ABAG+15118AI7ABAq+15118AI7ABAq0+15118AI7ABAK+15118AI7ABAK0+15118AI7ABAM+15118AI7ABAr+15118AI7ABAr0+15118AI7ABAr00+15118AI7ABAr000+15118AI7ABAL+15118AI7ABAN+15118AI7ABAO+15118AI7ABAP+15118AI7ABAQ+15118AI7ABAQ0+15118AI7ABAQ00+15118AI7ABAR+15118AI7ABAS+15118AI7ABAT+15118AI7ABAT0+15118AI7ABAU+15118AI7ABAV+15118AI7ABAV0+15118AI7ABAY+15118AI7ABAZ+15118AI7ABAJ+15118AI7ABAs+15118AI7AC+15118AI7ACAA+15118AI7AD+15118AI7ADAB+15118AI7AE+15118AI7AEAA+15118AI7AEAA0+15118AI7AEAA00+15118AI7AEAN+15118AI7AEAN0+15118AI7AEAB+15118AI7AEAC+15118AI7AEAF+15118AI7AEAH+15118AI7AEAI+15118AI7AEAI0+15118AI7AEAJ+15118AI7AEAK+15118AI7AEAM+15118AI7AF+15118AI7AFAA+15118AI7AG+15118AI7AGAC+15118AI7AGAA+15118AI7AGAB+15118AI7AH+15118AI7AHAA+15118AI7AK+15118AI7AKAA+15118AI7AJ+15118AI7AJAA+15118AI7AJAA0+15118AI7AJAA00+15118AI7AJAB+15118AI7AJAL+15118AI7AJAE+15118AI7AJAE0+15118AI7AJAF+15118AI7AJAG+15118AI7AJAH+15118AI7AJAH0+15118AI7AJAI+15118AI7AJAI00+15118AI7AJAI01+15118AI7AJAI010+15118AI7AJAJ+15118AI7AJAD+&objL2=15118AJ401+15118AJ402+15118AJ403+15118AJ404+15118AJ405+15118AJ406+15118AJ407+15118AJ408+15118AJ409+15118AJ410+15118AJ411+15118AJ412+15118AJ413+15118AJ414+15118AJ415+15118AJ416+15118AJ417+15118AJ418+15118AJ422+15118AJ423+15118AJ419+15118AJ420+15118AJ421+15118AJ424+15118AJ425+&objL3=&objL4=&objL5=&objL6=&objL7=&objL8=&format=json&jsonVD=Y&prdSe=Y&startPrdDe=2021&endPrdDe=2023&outputFields=OBJ_NM+NM+ITM_NM+PRD_DE+&orgId=118&tblId=DT_11806_N011"

    res = requests.get(url)
    res.raise_for_status()
    data = res.json()
    df = pd.DataFrame(data)

    objs = []
    for row in df.itertuples(index=False):
        obj = Stats6(
            c1_obj_nm=str(row.C1_OBJ_NM),
            c2_nm=str(row.C2_NM),
            dt=safe_float(row.DT),
            prd_de=int(row.PRD_DE),
            c1_nm=str(row.C1_NM),
            itm_nm=str(row.ITM_NM),
            c2_obj_nm=str(row.C2_OBJ_NM),
        )
        objs.append(obj)

    Stats6.objects.all().delete()
    Stats6.objects.bulk_create(objs, batch_size=1000)
    return len(objs)


def import_stats7():


    url = f"https://kosis.kr/openapi/Param/statisticsParameterData.do?method=getList&apiKey={API_KEY}&itmId=16118AAD6+&objL1=15118AI7AA+15118AI7AAAF+15118AI7AAAG+15118AI7AAAA+15118AI7AAAB+15118AI7AAAC+15118AI7AAAD+15118AI7AAAE+15118AI7AB+15118AI7ABAA+15118AI7ABAn+15118AI7ABAo+15118AI7ABAoo+15118AI7ABAB+15118AI7ABAB0+15118AI7ABAp+15118AI7ABAp0+15118AI7ABAD+15118AI7ABAD0+15118AI7ABAF+15118AI7ABAF0+15118AI7ABAH+15118AI7ABAH0+15118AI7ABAH00+15118AI7ABAG+15118AI7ABAq+15118AI7ABAq0+15118AI7ABAK+15118AI7ABAK0+15118AI7ABAM+15118AI7ABAr+15118AI7ABAr0+15118AI7ABAr00+15118AI7ABAr000+15118AI7ABAL+15118AI7ABAN+15118AI7ABAO+15118AI7ABAP+15118AI7ABAQ+15118AI7ABAQ0+15118AI7ABAQ00+15118AI7ABAR+15118AI7ABAS+15118AI7ABAT+15118AI7ABAT0+15118AI7ABAU+15118AI7ABAV+15118AI7ABAV0+15118AI7ABAY+15118AI7ABAZ+15118AI7ABAJ+15118AI7ABAs+15118AI7AC+15118AI7ACAA+15118AI7AD+15118AI7ADAB+15118AI7AE+15118AI7AEAA+15118AI7AEAA0+15118AI7AEAA00+15118AI7AEAN+15118AI7AEAN0+15118AI7AEAB+15118AI7AEAC+15118AI7AEAF+15118AI7AEAH+15118AI7AEAI+15118AI7AEAI0+15118AI7AEAJ+15118AI7AEAK+15118AI7AEAM+15118AI7AF+15118AI7AFAA+15118AI7AG+15118AI7AGAC+15118AI7AGAA+15118AI7AGAB+15118AI7AH+15118AI7AHAA+15118AI7AK+15118AI7AKAA+15118AI7AJ+15118AI7AJAA+15118AI7AJAA0+15118AI7AJAA00+15118AI7AJAB+15118AI7AJAL+15118AI7AJAE+15118AI7AJAE0+15118AI7AJAF+15118AI7AJAG+15118AI7AJAH+15118AI7AJAH0+15118AI7AJAI+15118AI7AJAI00+15118AI7AJAI01+15118AI7AJAI010+15118AI7AJAJ+15118AI7AJAD+&objL2=15118AJ401+15118AJ402+15118AJ403+15118AJ404+15118AJ405+15118AJ406+15118AJ407+15118AJ408+15118AJ409+15118AJ410+15118AJ411+15118AJ412+15118AJ413+15118AJ414+15118AJ415+15118AJ416+15118AJ417+15118AJ418+15118AJ422+15118AJ423+15118AJ419+15118AJ420+15118AJ421+15118AJ424+15118AJ425+&objL3=&objL4=&objL5=&objL6=&objL7=&objL8=&format=json&jsonVD=Y&prdSe=Y&startPrdDe=2021&endPrdDe=2023&outputFields=OBJ_NM+NM+ITM_NM+PRD_DE+&orgId=118&tblId=DT_11806_N022"

    res = requests.get(url)
    res.raise_for_status()
    data = res.json()
    df = pd.DataFrame(data)

    objs = []
    for row in df.itertuples(index=False):
        obj = Stats7(
            c1_obj_nm=str(row.C1_OBJ_NM),
            c2_nm=str(row.C2_NM),
            dt=safe_float(row.DT),
            prd_de=int(row.PRD_DE),
            c1_nm=str(row.C1_NM),
            itm_nm=str(row.ITM_NM),
            c2_obj_nm=str(row.C2_OBJ_NM),
        )
        objs.append(obj)

    Stats7.objects.all().delete()
    Stats7.objects.bulk_create(objs, batch_size=1000)
    return len(objs)


def import_stats8():
    """
    Stats8 : 전체 재해 현황 및 분석 - 세부질병
    """

    url = f"https://kosis.kr/openapi/Param/statisticsParameterData.do?method=getList&apiKey={API_KEY}&itmId=16118AAE1+&objL1=15118AI7AA+15118AI7AAAF+15118AI7AAAG+15118AI7AAAA+15118AI7AAAB+15118AI7AAAC+15118AI7AAAD+15118AI7AAAE+15118AI7AB+15118AI7ABAA+15118AI7ABAn+15118AI7ABAo+15118AI7ABAoo+15118AI7ABAB+15118AI7ABAC+15118AI7AC00+15118AI7AC000+15118AI7ABAp+15118AI7ABAp0+15118AI7ABAD+15118AI7ABAD0+15118AI7ABAE+15118AI7ABAF+15118AI7ABAF0+15118AI7ABAH+15118AI7ABAH0+15118AI7ABAH00+15118AI7ABAJ+15118AI7ABAG+15118AI7ABAq+15118AI7ABAq0+15118AI7ABAK+15118AI7ABAK0+15118AI7ABAM+15118AI7ABAr+15118AI7ABAr0+15118AI7ABAr00+15118AI7ABAr000+15118AI7ABAL+15118AI7ABAN+15118AI7ABAO+15118AI7ABAP+15118AI7ABAQ+15118AI7ABAQ0+15118AI7ABAQ00+15118AI7ABAR+15118AI7ABAS+15118AI7ABAT+15118AI7ABAT0+15118AI7ABAU+15118AI7ABAV+15118AI7ABAV0+15118AI7ABAY+15118AI7ABAZ+15118AI7ABAZ00+15118AI7ABAX+15118AI7ABAs+15118AI7AC+15118AI7ACAA+15118AI7AC01+15118AI7AD+15118AI7ADAB+15118AI7AE+15118AI7AEAA+15118AI7AEAA0+15118AI7AEAA00+15118AI7AEAN+15118AI7AEAN0+15118AI7AEAB+15118AI7AEAC+15118AI7AEAF+15118AI7AEAH+15118AI7AEAI+15118AI7AEAI0+15118AI7AEAJ+15118AI7AEAK+15118AI7AEAM+15118AI7AF+15118AI7AFAA+15118AI7AG+15118AI7AGAC+15118AI7AGAA+15118AI7AGAB+15118AI7AH+15118AI7AHAA+15118AI7AK+15118AI7AKAA+15118AI7AJ+15118AI7AJAA+15118AI7AJAA0+15118AI7AJAA00+15118AI7AJAB+15118AI7AJAC+15118AI7AJAL+15118AI7AJAE+15118AI7AJAE0+15118AI7AJAF+15118AI7AJAG+15118AI7AJAH+15118AI7AJAH0+15118AI7AJAI+15118AI7AC02+15118AI7AC03+15118AI7AC030+15118AI7AJAJ+15118AI7AJAD+&objL2=15118AC3BM+15118AC3BMAA+15118AC3BMAB+15118AC3BMAC+15118AC3BMAD+15118AC3BMAE+15118AC3BMAF+15118AC3BMAG+15118AC3BMAH+15118AC3BMAI+15118AC3BMAJ+15118AC3BMAJ0+15118AC3BMAL+15118AC3BMAM+15118AC3BMAN+15118AC3BMAO+15118AC3BMAP+15118AC3BMAQ+15118AC3BMAR+15118AC3BMAS+15118AC3BMAT+15118AC3BMAV01+15118AC3BMAU+15118AC3BMAV00+15118AC3BMAV+15118AC3BN+15118AC3BNAA+15118AC3BNAC+15118AC3BNAB+15118AC3BNAD+15118AC3BNAE+15118AC3BNAG+15118AC3BNAL+15118AC3BNAI+15118AC3BNAJ+15118AC3BNAK+&objL3=&objL4=&objL5=&objL6=&objL7=&objL8=&format=json&jsonVD=Y&prdSe=Y&startPrdDe=2021&endPrdDe=2023&outputFields=OBJ_NM+NM+ITM_NM+PRD_DE+&orgId=118&tblId=DT_11806_N038"

    res = requests.get(url)
    res.raise_for_status()
    data = res.json()
    df = pd.DataFrame(data)

    objs = []
    for row in df.itertuples(index=False):
        obj = Stats8(
            c1_obj_nm=str(row.C1_OBJ_NM),
            c2_nm=str(row.C2_NM),
            dt=safe_float(row.DT),
            prd_de=int(row.PRD_DE),
            c1_nm=str(row.C1_NM),
            itm_nm=str(row.ITM_NM),
            c2_obj_nm=str(row.C2_OBJ_NM),
        )
        objs.append(obj)

    Stats8.objects.all().delete()
    Stats8.objects.bulk_create(objs, batch_size=1000)
    return len(objs)


def import_stats9():


    url = f"https://kosis.kr/openapi/Param/statisticsParameterData.do?method=getList&apiKey={API_KEY}&itmId=16118AAE1+&objL1=15118AI7AA+15118AI7AAAF+15118AI7AAAG+15118AI7AAAA+15118AI7AAAB+15118AI7AAAC+15118AI7AAAD+15118AI7AAAE+15118AI7AB+15118AI7ABAA+15118AI7ABAn+15118AI7ABAo+15118AI7ABAoo+15118AI7ABAB+15118AI7ABAC+15118AI7AC00+15118AI7AC000+15118AI7ABAp+15118AI7ABAp0+15118AI7ABAD+15118AI7ABAD0+15118AI7ABAE+15118AI7ABAF+15118AI7ABAF0+15118AI7ABAH+15118AI7ABAH0+15118AI7ABAH00+15118AI7ABAJ+15118AI7ABAG+15118AI7ABAq+15118AI7ABAq0+15118AI7ABAK+15118AI7ABAK0+15118AI7ABAM+15118AI7ABAr+15118AI7ABAr0+15118AI7ABAr00+15118AI7ABAr000+15118AI7ABAL+15118AI7ABAN+15118AI7ABAO+15118AI7ABAP+15118AI7ABAQ+15118AI7ABAQ0+15118AI7ABAQ00+15118AI7ABAR+15118AI7ABAS+15118AI7ABAT+15118AI7ABAT0+15118AI7ABAU+15118AI7ABAV+15118AI7ABAV0+15118AI7ABAY+15118AI7ABAZ+15118AI7ABAZ00+15118AI7ABAX+15118AI7ABAs+15118AI7AC+15118AI7ACAA+15118AI7AC01+15118AI7AD+15118AI7ADAB+15118AI7AE+15118AI7AEAA+15118AI7AEAA0+15118AI7AEAA00+15118AI7AEAN+15118AI7AEAN0+15118AI7AEAB+15118AI7AEAC+15118AI7AEAF+15118AI7AEAH+15118AI7AEAI+15118AI7AEAI0+15118AI7AEAJ+15118AI7AEAK+15118AI7AEAM+15118AI7AF+15118AI7AFAA+15118AI7AG+15118AI7AGAC+15118AI7AGAA+15118AI7AGAB+15118AI7AH+15118AI7AHAA+15118AI7AK+15118AI7AKAA+15118AI7AJ+15118AI7AJAP+15118AI7AJAA+15118AI7AJAA0+15118AI7AJAA00+15118AI7AJAB+15118AI7AJAC+15118AI7AJAL+15118AI7AJAE+15118AI7AJAE0+15118AI7AJAF+15118AI7AJAG+15118AI7AJAH+15118AI7AJAH0+15118AI7AJAI+15118AI7AC02+15118AI7AC03+15118AI7AC030+15118AI7AJAJ+15118AI7AJAD+&objL2=15118AC3BM+15118AC3BMAA+15118AC3BMAB+15118AC3BMAC+15118AC3BMAD+15118AC3BMAE+15118AC3BMAF+15118AC3BMAG+15118AC3BMAH+15118AC3BMAI+15118AC3BMAJ+15118AC3BMAJ0+15118AC3BMAL+15118AC3BMAM+15118AC3BMAN+15118AC3BMAO+15118AC3BMAP+15118AC3BMAQ+15118AC3BMAR+15118AC3BMAS+15118AC3BMAT+15118AC3BMAV01+15118AC3BMAU+15118AC3BMAV00+15118AC3BMAV+15118AC3BN+15118AC3BNAA+15118AC3BNAC+15118AC3BNAB+15118AC3BNAD+15118AC3BNAE+15118AC3BNAG+15118AC3BNAL+15118AC3BNAI+15118AC3BNAJ+15118AC3BNAK+&objL3=&objL4=&objL5=&objL6=&objL7=&objL8=&format=json&jsonVD=Y&prdSe=Y&startPrdDe=2021&endPrdDe=2023&outputFields=OBJ_NM+NM+ITM_NM+PRD_DE+&orgId=118&tblId=DT_11806_N055"

    res = requests.get(url)
    res.raise_for_status()
    data = res.json()
    df = pd.DataFrame(data)

    objs = []
    for row in df.itertuples(index=False):
        obj = Stats9(
            c1_obj_nm=str(row.C1_OBJ_NM),
            c2_nm=str(row.C2_NM),
            dt=safe_float(row.DT),
            prd_de=int(row.PRD_DE),
            c1_nm=str(row.C1_NM),
            itm_nm=str(row.ITM_NM),
            c2_obj_nm=str(row.C2_OBJ_NM),
        )
        objs.append(obj)

    Stats9.objects.all().delete()
    Stats9.objects.bulk_create(objs, batch_size=1000)
    return len(objs)


# -----------------------------
# 메인 Command
# -----------------------------

class Command(BaseCommand):
    help = "KOSIS API에서 Stats1~Stats9 데이터를 가져와 DB(t_stats1~t_stats9)에 저장합니다."

    def add_arguments(self, parser):
        parser.add_argument(
            "--only",
            type=int,
            choices=range(1, 10),
            help="특정 Stats 번호만 가져오고 싶으면 사용 (예: --only 3)",
        )

    def handle(self, *args, **options):
        only = options.get("only")

        funcs = [
            (2, import_stats2),
            (3, import_stats3),
            (4, import_stats4),
            (5, import_stats5),
            (6, import_stats6),
            (7, import_stats7),
            (8, import_stats8),
            (9, import_stats9),
        ]

        for num, func in funcs:
            if only and only != num:
                continue

            self.stdout.write(self.style.NOTICE(f"▶ Stats{num} 가져오는 중..."))
            try:
                cnt = func()
                self.stdout.write(self.style.SUCCESS(f"  → Stats{num}: {cnt}건 저장 완료"))
            except Exception as e:
                self.stdout.write(self.style.ERROR(f"  ✕ Stats{num} 실패: {e}"))
